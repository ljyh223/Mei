package com.ljyh.mei

import com.ljyh.mei.utils.lyric.QRCParser

import com.mocharealm.accompanist.lyrics.core.model.SyncedLyrics
import com.mocharealm.accompanist.lyrics.core.model.karaoke.KaraokeLine
import org.junit.Assert.*
import org.junit.Test

/**
 * QRCParser 的单元测试
 * 运行方式：在 Android Studio 中点击类名或方法名旁边的绿色三角形 "Run 'QRCParseTest'"
 */
class QRCParseTest {

    // 模拟一段包含元数据（词、曲）的 QRC 歌词
    private val rawQrc = """
        [ti:雑踏、僕らの街 (《哭泣少女乐队》TV动画片头曲)]

        [ar:トゲナシトゲアリ]

        [al:雑踏、僕らの街]

        [by:]

        [offset:0]

        [kana:1ざっ1とう1ぼく1まち1し1おお1はま1けん1ご1きょく1おお1はま1けん1ご1へん1きょく1たま1い1けん1じ1おお1はま1けん1ご1111たま1い1けん1じ1の(1004,128)こ(1132,224)1こ1どう1よ1おお1ぼ(3400,200)く(3600,168)1つ(4112,136)つ(4248,88)1こな1ご(4872,120)な(4992,72)1ま(5672,168)え(5840,120)1たよ1て1て1じ1ぶん1じ1しん1か1て1の1ざっ1とう1なか1こ(21008,288)え(21296,200)1な1こ(21735,232)え(21967,184)1な1あ(23470,232)し(23702,191)1あと1い(24424,184)ま(24608,704)1だ(25312,240)れ(25552,185)1こ(26312,192)え(26504,216)1け1あ(27448,128)さ(27576,195)1か1ふ1は(31941,184)い(32125,296)1まち1ど(33815,192)ろ(34007,144)1み(34151,360)ず(34511,168)1つ(35071,192)め(35263,736)1なん1か1せ1かい2きょう1い1し1か(43188,256)た(43444,168)1ぼ(44180,192)く(44372,168)1あ(45061,255)る(45316,200)1は(45748,184)じ(45932,144)1うそ1ば1か1ぼ(51728,200)く(51928,168)1ま(52432,304)ち(52736,177)1め1たし1み1て1たし1ふ1ふ1ば1か1や(62828,248)み(63076,128)1て1ゆめ1お1まち1あ(66370,136)き(66506,96)ら(66602,112)1か1のこ1こ1どう1よ1おお1ぼく1つ(73560,128)つ(73688,92)1こ(74042,174)な(74216,208)1ご(74424,136)な(74560,112)1ま(75152,152)え(75304,56)1た(75684,168)よ(75852,136)1て1て1じ1ぶん1じ1しん1か1て1の1えい1えん1な(89655,176)か(89831,128)1まよ1た(91639,192)め(91831,160)1ぬく1けい1はく1きみ1と(94714,192)ど(94906,240)1ち1そう1ぞう1どお1に1かん1たん1い1どお1せ1か(107290,136)い(107426,72)2きょう1か1すべ1お1つか1は(113722,192)い(113914,128)1い(114042,96)ろ(114138,72)1そ(114426,136)ら(114562,104)1な(115010,224)か(115234,160)1き(115594,152)ら(115746,112)1あ(116366,392)お(116758,744)1うそ1ば1か1ぼ(132376,200)く(132576,160)1ま(133128,160)ち(133288,360)1め1たし1み1て1た(136108,120)し(136228,96)1ふ1ふ1ば1か1や(143737,176)み(143913,152)1て1ゆめ1お1ま(146386,80)ち(146466,128)1あ(147018,128)き(147146,72)ら(147218,120)1か1の(151150,144)こ(151294,176)1こ1どう1よ1おお1ぼ(153582,200)く(153782,160)1つ(154310,136)つ(154446,112)1こ(154822,168)な(154990,144)1ごな1ま(155790,152)え(155942,104)1た(156331,152)よ(156483,192)1て1て1じ1ぶん1じ1しん1か1て1の1な(166715,184)に(166899,144)1き(167499,144)み(167643,96)1し1だ(167835,128)い(167963,80)1ぼ(168251,264)く(168515,200)1し1だ(168891,152)い(169043,249)]

        [0,202]雑(0,20)踏(20,20)、(41,10)僕(51,20)ら(71,10)の(81,10)街(91,20) - (112,10)ト(122,10)ゲ(132,10)ナ(142,10)シ(152,10)ト(163,10)ゲ(173,10)ア(183,10)リ(193,10)

        [203,90]词(203,10)：(213,10)大(223,20)濱(244,20)健(264,20)悟(284,10)

        [295,111]曲(295,30)：(325,10)大(335,20)濱(356,20)健(376,20)悟(396,10)

        [406,101]编(406,20)曲(427,30)：(457,10)玉(467,20)井(488,10)健(498,2)二(500,1)/(501,1)大(502,2)濱(504,2)健(506,2)悟(508,1)

        [509,142]制(509,1)作(510,1)人(511,1)：(512,1)玉(513,2)井(515,1)健(516,2)二(518,134)

        [652,2748]や(652,184)り(836,168)残(1004,352)し(1356,168)た(1524,144)鼓(1668,104)動(1772,264)が(2036,160)こ(2196,112)の(2308,80)夜(2388,128)を(2516,96)覆(2612,362)っ(2975,181)て(3156,244)

        [3400,2864]僕(3400,368)ら(3768,136)を(3904,208)包(4112,224)ん(4336,88)で(4424,152) (4576,0)粉(4576,296)々(4872,192)に(5064,136)な(5200,240)る(5440,232)前(5672,288)に(5960,304)

        [6264,1842]頼(6264,344)り(6608,136)な(6744,208)く(6952,168)て(7120,152)も(7272,200)い(7472,48)い(7520,48) (7568,48)そ(7616,136)の(7752,88)手(7840,128)を(7968,138)

        [8106,2702]こ(8106,200)の(8306,136)手(8442,216)は(8658,120)自(8778,216)分(8994,152)自(9146,160)身(9306,128)の(9434,176)も(9610,368)の(9978,136)さ(10114,694)

        [10808,1696]変(10808,216)わ(11024,168)ら(11192,184)な(11376,144)い(11520,96)は(11616,208)ず(11824,128)は(11952,104)な(12056,120)い(12176,112)よ(12288,216)
    """.trimIndent()

    // 模拟一段包含版权声明和正文的翻译 LRC
    private val rawLrc = """
        [ti:雑踏、僕らの街 (《哭泣少女乐队》TV动画片头曲)]
        [ar:トゲナシトゲアリ]
        [al:雑踏、僕らの街]
        [by:]
        [offset:0]
        [kana:1ざっ1とう1ぼく1まち1し1おお1はま1けん1ご1きょく1おお1はま1けん1ご1へん1きょく1たま1い1けん1じ1おお1はま1けん1ご1111たま1い1けん1じ1のこ1こ1どう1よ1おお1ぼく1つつ1こな1ごな1まえ1たよ1て1て1じ1ぶん1じ1しん1か1て1の1ざっ1とう1なか1こえ1な1こえ1な1あし1あと1いま1だれ1こえ1け1あさ1か1ふ1はい1まち1どろ1みず1つめ1なん1か1せ1かい2きょう1い1し1かた1ぼく1ある1はじ1うそ1ば1か1ぼく1まち1め1たし1み1て1たし1ふ1ふ1ば1か1やみ1て1ゆめ1お1まち1あきら1か1のこ1こ1どう1よ1おお1ぼく1つつ1こな1ごな1まえ1たよ1て1て1じ1ぶん1じ1しん1か1て1の1えい1えん1なか1まよ1ため1ぬく1けい1はく1きみ1とど1ち1そう1ぞう1どお1に1かん1たん1い1どお1せ1かい2きょう1か1すべ1お1つか1はい1いろ1そら1なか1きら1あお1うそ1ば1か1ぼく1まち1め1たし1み1て1たし1ふ1ふ1ば1か1やみ1て1ゆめ1お1まち1あきら1か1のこ1こ1どう1よ1おお1ぼく1つつ1こな1ごな1まえ1たよ1て1て1じ1ぶん1じ1しん1か1て1の1なに1きみ1し1だい1ぼく1し1だい]
        [00:00.00]TME享有本翻译作品的著作权
        [00:00.20]//
        [00:00.29]//
        [00:00.40]//
        [00:00.50]//
        [00:00.65]仍旧尚存的心跳充斥于这个夜晚
        [00:03.40]在粉身碎骨前将我们包覆其中
        [00:06.26]哪怕不去依赖那双援手也无妨
        [00:08.10]这双手正是属于你自己的
        [00:10.80]一切应该都能改换一新
    """.trimIndent()

    @Test
    fun testParse_ShouldFilterMetadataAndMergeCorrectly() {
        // 执行解析
        val syncedLyrics: SyncedLyrics = QRCParser.parse(rawQrc, rawLrc)
        val lines: List<KaraokeLine> = syncedLyrics.lines as List<KaraokeLine>

        println("解析出的行数: ${lines.size}")
        lines.forEach {
            println("时间:[${it.start}] 内容:[${it.syllables.joinToString("") { s-> s.content }}] 翻译:[${it.translation}]")
        }

        // ================== 断言验证 ==================

        // 1. 验证解析出的行数是否正确 (根据 rawQrc 应该有 4 行有效数据)
        assertEquals("解析出的行数不匹配", 10, lines.size)

        // 2. 获取各个关键行
        val titleLine = lines[0] // 雑踏、僕らの街 - トゲナシトゲアリ
        val lyricistLine = lines[1] // 词：大濱健悟
        val composerLine = lines[2] // 曲：大濱健悟
        val firstSongLine = lines[5] // やり残した鼓動がこの夜を覆って

        // 3. 验证元数据行（词/曲）不应该有翻译
        // 如果你的修复代码生效（过滤了TME + 增加了时间阈值），这里应该是 null 或 ""
        assertNull(
            "错误：'词' 信息行不应该被分配翻译，请检查 maxDelay 阈值或版权信息过滤",
            lyricistLine.translation
        )
        assertNull(
            "错误：'曲' 信息行不应该被分配翻译",
            composerLine.translation
        )

        // 4. 验证正文歌词应该匹配到正确的翻译
        // 正文时间 652ms，翻译时间 650ms (00:00.65)，两者非常接近，应该匹配成功
        assertEquals(
            "错误：正文第一句歌词没有匹配到正确的翻译",
            "仍旧尚存的心跳充斥于这个夜晚",
            firstSongLine.translation
        )

        // 5. 验证 TME 版权声明没有被错误匹配给第一行 (Title)
        // Title 行在 0ms，TME 也在 0ms。
        // 如果你的 parseTranslation 增加了 "TME" 过滤，这里应该是 null。
        // 如果没过滤 TME 但有时间匹配，可能会被匹配上（取决于你的业务需求，通常标题行不需要翻译）
        if (titleLine.translation != null) {
            assertNotEquals(
                "错误：标题行不应该匹配到 'TME...著作权' 这种垃圾信息",
                "TME享有本翻译作品的著作权",
                titleLine.translation
            )
        }
    }

    @Test
    fun testParse_WithHugeGap_ShouldNotTranslate() {
        // 测试时间差过大的情况（例如 10秒的间隙）
        val qrcWithGap = "[1000,2000]Testing(1000,2000)"
        val lrcFarAway = "[00:10.00]远处的翻译" // 10000ms

        val result = QRCParser.parse(qrcWithGap, lrcFarAway)
        val line: KaraokeLine = result.lines.first() as KaraokeLine

        assertNull(
            "当歌词时间(1s)与翻译时间(10s)相差过大时，不应强行匹配",
            line.translation
        )
    }
}